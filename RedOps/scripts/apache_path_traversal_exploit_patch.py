from pathlib import Path

try:
    project_root = Path(__file__).resolve().parent
except NameError:
    project_root = Path.cwd()

exploiter_path = project_root / "RedOps" / "Core" / "exploiter.py"

code = exploiter_path.read_text()

# Only add PoC if not already included
if "apache_path_traversal" not in code:
    insert_code = """
        elif cve == "CVE-2021-41773":
            print("[*] Triggering Apache Path Traversal PoC...")
            from core.exploits import apache_path_traversal
            if apache_path_traversal.check_apache_path_traversal(target):
                apache_path_traversal.attempt_rce(target)
    """

# Insert inside loop for matched CVEs
    if 'for cve in cves:' in code:
        lines = code.splitlines()
        for i, line in enumerate(lines):
            if 'for cve in cves:' in line:
                insert_index = i + 1
                while insert_index < len(lines) and (lines[insert_index].strip().startswith("print") or lines[insert_index].strip() == ""):
                    insert_index += 1
                lines.insert(insert_index, insert_code.strip())
                break
        updated_code = "\n".join(lines)
    else:
        updated_code = code  # fallback if structure is missing

    exploiter_path.write_text(updated_code)
    print(f"[âœ”] CVE-2021-41773 PoC added to: {exploiter_path.resolve()}")
else:
    print("[*] CVE-2021-41773 PoC already present.")