from pathlib import Path

try:
    project_root = Path(__file__).resolve().parent
except NameError:
    project_root = Path.cwd()

exploiter_path = project_root / "RedOps" / "core" / "exploiter.py"

# Read file
exploiter_code = exploiter_path.read_text()

# Only add ProxyShell logic if not already present
if "proxyshell" not in exploiter_code:
    insert_code = """
        elif cve == "CVE-2021-34473":
            print("[*] Triggering ProxyShell PoC...")
            from core.exploits import proxyshell
            if proxyshell.check_proxyshell(target):
                proxyshell.simulate_exploit(target)
    """

    if 'for cve in cves:' in exploiter_code:
        lines = exploiter_code.splitlines()
        for i, line in enumerate(lines):
            if 'for cve in cves:' in line:
                insert_index = i + 1
                while insert_index < len(lines) and (
                    lines[insert_index].strip().startswith("print") or
                    lines[insert_index].strip() == ""
                ):
                    insert_index += 1
                lines.insert(insert_index, insert_code.strip())
                break
        updated_code = "\n".join(lines)
        exploiter_path.write_text(updated_code)
        print(f"[âœ”] ProxyShell PoC inserted into: {exploiter_path.resolve()}")
    else:
        print("[!] 'for cve in cves:' block not found. No changes made.")
else:
    print("[*] ProxyShell logic already present.")
