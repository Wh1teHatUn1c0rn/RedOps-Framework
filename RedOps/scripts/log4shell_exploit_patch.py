from pathlib import Path

try:
    project_root = Path(__file__).resolve().parent
except NameError:
    project_root = Path.cwd()

exploiter_path = project_root / "RedOps" / "Core" / "exploiter.py"

# Read existing code
exploiter_code = exploiter_path.read_text()

# Insert Log4Shell PoC if not already present
if "log4shell" not in exploiter_code:
    insert_code = """
        elif cve == "CVE-2021-44228":
            print("[*] Triggering Log4Shell PoC...")
            from core.exploits import log4shell
            if log4shell.check_log4shell_vuln(target):
                log4shell.simulate_exploit(target)
    """

    if 'for cve in cves:' in exploiter_code:
        lines = exploiter_code.splitlines()
        for i, line in enumerate(lines):
            if 'for cve in cves:' in line:
                insert_index = i + 1
                while insert_index < len(lines) and (
                    lines[insert_index].strip().startswith("print") or
                    lines[insert_index].strip() == ""
                ):
                    insert_index += 1
                lines.insert(insert_index, insert_code.strip())
                break
        updated_code = "\n".join(lines)
        exploiter_path.write_text(updated_code)
        print(f"[âœ”] Log4Shell PoC inserted into: {exploiter_path.resolve()}")
    else:
        print("[!] 'for cve in cves:' block not found. No insertion made.")
else:
    print("[*] Log4Shell PoC already present.")
