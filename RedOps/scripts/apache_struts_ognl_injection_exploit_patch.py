from pathlib import Path

try:
    project_root = Path(__file__).resolve().parent
except NameError:
    project_root = Path.cwd()

exploiter_path = project_root / "RedOps" / "Core" / "exploiter.py"

# Read exploiter.py
exploiter_code = exploiter_path.read_text()

if "apache_struts" not in exploiter_code:
    insert_code = """
        elif cve == "CVE-2017-5638":
            print("[*] Triggering Apache Struts OGNL PoC...")
            from core.exploits import apache_struts
            if apache_struts.check_struts_rce(target):
                apache_struts.simulate_rce(target)
    """

    if 'for cve in cves:' in exploiter_code:
        lines = exploiter_code.splitlines()
        for i, line in enumerate(lines):
            if 'for cve in cves:' in line:
                insert_index = i + 1
                while insert_index < len(lines) and (
                    lines[insert_index].strip().startswith("print") or
                    lines[insert_index].strip() == ""
                ):
                    insert_index += 1
                lines.insert(insert_index, insert_code.strip())
                break
        updated_code = "\n".join(lines)
        exploiter_path.write_text(updated_code)
        print(f"[âœ”] CVE-2017-5638 Struts PoC inserted into: {exploiter_path.resolve()}")
    else:
        print("[!] Loop 'for cve in cves:' not found. No insertion made.")
else:
    print("[*] CVE-2017-5638 Struts PoC already present.")


